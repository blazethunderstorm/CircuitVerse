#!/usr/bin/env ruby
require "fileutils"

APP_ROOT = File.expand_path("..", __dir__)

def system!(cmd)
  puts "â†’ Running: #{cmd}"
  system(cmd) || abort("\n== Command failed: #{cmd} ==")
end

FileUtils.chdir(APP_ROOT) do
  puts "CircuitVerse Rails 7 Environment Setup"
  puts "======================================="

  # 1. Install/update Bundler and Gems
  puts "\n== Installing dependencies =="
  system!("gem install bundler --conservative")
  system("bundle check") || system!("bundle install")

  # 2. Set up JS (Importmap or jsbundling-rails)
  puts "\n== Setting up JavaScript pipeline =="
  if File.exist?("app/javascript/application.js")
    puts "âœ“ JS entrypoint exists"
  else
    puts "âš ï¸  Missing app/javascript/application.js â€” ensure importmap or bundler is installed"
  end

  # 3. Prepare the database
  puts "\n== Preparing database =="
  system!("bin/rails db:prepare")

  # 4. Clean logs and tmp files
  puts "\n== Cleaning old logs and tmp files =="
  system!("bin/rails log:clear tmp:clear")

  # 5. Restart the Rails server if applicable
  puts "\n== Restarting Rails server if needed =="
  system!("bin/rails restart")

  # 6. Post-setup instructions
  puts "\n\nğŸ‰ Setup completed successfully!"
  puts "\nTo start the development server, you can use:"
  if File.exist?("bin/dev")
    puts "  bin/dev"
    puts "\nThis will start Rails, your asset watcher, and any background jobs as configured."
  else
    puts "  rails server"
    puts "\nIf you're using jsbundling-rails or importmaps, ensure your JS watcher is running via:"
    puts "  ./bin/rails assets:watch (if configured) or refer to your setup instructions."
  end
  puts "\nVisit http://localhost:3000 to begin developing!"
end
